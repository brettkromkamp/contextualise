{% extends "layout.html" %}

{% block title %}
<title>{{ topic.first_base_name.name }} | {{ topic_map.name }}</title>
{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet" />
<link href="{{ url_for('static', filename='default.css', version='1.0') }}" rel="stylesheet">
<style>
    .fancybox-slide--iframe .fancybox-content {
        max-width: 100%;
        max-height: 100%;
        margin: 0;
    }
</style>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script type="module">
    window.__ASSOCIATIONS_STATE__ = JSON.parse({{ associations_state | tojson }});
    window.__SCOPE_IDENTIFIER__ = "{{ session['current_scope'] }}";
    window.__TOPIC_IDENTIFIER__ = "{{ topic.identifier }}";
    window.__MAP_IDENTIFIER__ = "{{ topic_map.identifier }}";

    // TODO: Document!
    window.__IS_AUTHENTICATED__ = JSON.parse({{ "true" if current_user.is_authenticated else "false" }});
    window.__HAS_WRITE_ACCESS__ = JSON.parse({{ "true" if is_map_owner or collaboration_mode.name == 'EDIT' else "false" }});

    function getUrlParams(url) {
        var params = {};
        (url + '?').replace('#', '').split('?')[1].split('&').forEach(function (pair) {
            pair = (pair + '=').split('=').map(decodeURIComponent);
            if (pair[0].length) {
                params[pair[0]] = pair[1];
            }
        });
        return params;
    }

    var urlParts = window.location.pathname.split("/");
    var mapIdentifier = urlParts[3];
    var associationCreateApiUrl = "/api/create-association/" + mapIdentifier;
    var filter = getUrlParams(window.location)['filter'] === undefined ? 1 : getUrlParams(window.location)['filter'];
    var associationsGetGroupsApiUrl = "/api/get-association-groups/" + mapIdentifier
        + "/" + window.__TOPIC_IDENTIFIER__
        + "/" + window.__SCOPE_IDENTIFIER__
        + "/" + filter;
    var getIdentifiersApiUrl =
        "/api/get-identifiers/" + mapIdentifier + "?q=%QUERY";
    var createAssociation = false;
    var notyf = new Notyf({
        position: { x: "right", y: "top" },
        dismissible: true,
        duration: 3000,
    });

    // TODO: Verify!
    $(function () {
        $('[data-toggle="popover"]').popover()
    })

    // Associations component
    var associationsComponent = new Vue({
        el: "#associations-component",
        delimiters: ['${', '}'],
        data: {
            mapIdentifier: window.__MAP_IDENTIFIER__,
            topicIdentifier: window.__TOPIC_IDENTIFIER__,
            currentScope: window.__SCOPE_IDENTIFIER__,
            isAuthenticated: window.__IS_AUTHENTICATED__,
            hasWriteAccess: window.__HAS_WRITE_ACCESS__,
            associations: window.__ASSOCIATIONS_STATE__
        },
        computed: {
            visibleAssociations: function () {
                if (this.associations != null) {
                    return this.associations.filter(function (association) {
                        return association.identifier !== 'navigation' && association.identifier !== 'categorization';
                    })
                } else {
                    return {}
                }
            }
        }
    });

    document
        .querySelectorAll(".create-association-link").forEach(function (element, index, array) {
            element.addEventListener("click", function () {
                $("#createAssociationModal").modal("show");
                createAssociation = false;
            });
        });

    if (document.getElementById("create-association-modal-button") != null) {
        document
            .getElementById("create-association-modal-button")
            .addEventListener("click", function () {
                $("#createAssociationModal").modal("hide");
                createAssociation = true;
            });
    }

    $("#createAssociationModal").on("hidden.bs.modal", function (e) {
        var modal = $(this);
        var associationDestTopicRef = modal.find(".modal-body #create-association-dest-topic-ref").val();
        modal.find(".modal-body #create-association-dest-topic-ref").val("");
        if (createAssociation) {
            var bodyFormData = new FormData();
            bodyFormData.set("association-dest-topic-ref", associationDestTopicRef);
            bodyFormData.set("association-dest-role-spec", "related");
            bodyFormData.set("association-src-topic-ref", window.__TOPIC_IDENTIFIER__);
            bodyFormData.set("association-src-role-spec", "related");
            bodyFormData.set("association-instance-of", "association");
            bodyFormData.set("association-scope", window.__SCOPE_IDENTIFIER__);
            bodyFormData.set("association-name", "Undefined");
            bodyFormData.set("association-identifier", "");

            axios({
                method: "post",
                url: associationCreateApiUrl,
                data: bodyFormData,
                headers: { "Content-Type": "multipart/form-data" },
            })
                .then(function (response) {
                    notyf.success("Association successfully created!");
                    axios({
                        method: "get",
                        url: associationsGetGroupsApiUrl
                    })
                        .then(function (response) {
                            associationsComponent.associations = response.data;
                        })
                        .catch(function (error) {
                            notyf.error("Unable to retrieve associations!");
                        })
                })
                .catch(function (error) {
                    notyf.error("Unable to create association!");
                });
        }
    });
</script>
{% endblock %}

{% block header_menu %}
{% include "_header_menu.html" %}
<li class="nav-item d-flex justify-content-center">
    <button class="btn btn-outline-primary mx-2" data-bs-toggle="modal" data-bs-target="#gotoModal" type="reset">Go to
        topic
    </button>
</li>
{% endblock %}

{% block header_menu_not_authenticated %}
<li class="nav-item"><a class="nav-link" href="{{ url_for('map.published') }}">Published maps</a></li>
<li class="nav-item">
    {% if map_notes_count == 0 %}
    <a class="nav-link" href="{{ url_for('note.index', map_identifier=topic_map.identifier) }}">Notes</a>
    {% else %}
    <a class="nav-link" href="{{ url_for('note.index', map_identifier=topic_map.identifier) }}">Notes&nbsp;<span
            class="badge rounded-pill text-bg-danger">
            {{ map_notes_count }}
        </span>
    </a>
    {% endif %}
</li>
{% if topic.identifier != 'home' %}
<li class="nav-item">
    {% if session['current_scope'] == '*' %}
    <a class="nav-link" href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier='home') }}"
        role="button">Home</a>
    {% else %}
    <a class="nav-link"
        href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier='home', scope=session['current_scope']) }}"
        role="button">Home</a>
    {% endif %}
</li>
{% else %}
<li class="nav-item">
    <a class="nav-link disabled">Home</a>
</li>
{% endif %}
{% endblock %}

{% block content %}
<!-- Tabs -->
<div class="row">
    <div class="col-md-12">
        {% if not current_user.is_authenticated or not collaboration_mode or collaboration_mode.name ==
        "VIEW" %}
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">Topic</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Visualisations</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item"
                            href="{{ url_for('visualisation.network', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            network graph</a></li>
                    <li><a class="dropdown-item"
                            href="{{ url_for('visualisation.tags_cloud', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            tags cloud</a></li>
                    <li><a class="dropdown-item" href="#">View timeline</a></li>
                    <li><a class="dropdown-item" href="#">View geographic map</a></li>
                </ul>
            </li>
        </ul>
        {% endif %}
        {% if current_user.is_authenticated and collaboration_mode.name == "COMMENT" %}
        <ul class="nav nav-tabs">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Topic</a>
                <ul class="dropdown-menu">
                    <li><a aria-disabled="true" class="dropdown-item disabled" href="#" tabindex="-1">View</a></li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.add_note', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Add
                            note</a>
                    </li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Visualisations</a>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('visualisation.network', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            network graph</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('visualisation.tags_cloud', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            tags cloud</a>
                    </li>
                    <li><a class="dropdown-item" href="#">View timeline</a></li>
                    <li><a class="dropdown-item" href="#">View geographic map</a></li>
                </ul>
            </li>
        </ul>
        {% endif %}
        {% if current_user.is_authenticated and collaboration_mode.name == "EDIT" %}
        <ul class="nav nav-tabs">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Topic</a>
                <ul class="dropdown-menu">
                    <li><a aria-disabled="true" class="dropdown-item disabled" href="#" tabindex="-1">View</a></li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.create', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Create
                            topic</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.edit', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Edit
                            topic</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.edit_identifier', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Edit
                            identifier</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.delete', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Delete
                            topic</a>
                    </li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.view_names', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            names</a>
                    </li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.add_note', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Add
                            note</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('tag.add', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Add
                            tags</a>
                    </li>
                    {% if 'admin' in current_user.roles %}
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('attribute.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            attributes</a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Resources</a>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('image.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View</a>
                    </li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('image.upload', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Upload
                            image</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('file.upload', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Upload
                            file</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('video.add', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Add
                            video</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('link.add', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Add
                            link</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('three_d.upload', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Upload
                            3D scene</a>
                    </li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Associations</a>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('association.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View</a>
                    </li>
                    <li>
                        <div class="dropdown-divider"></div>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('association.create', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Create
                            association</a>
                    </li>
                    <li>
                        <a class="dropdown-item create-association-link" href="#">Create generic
                            association</a>
                    </li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">Visualisations</a>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('visualisation.network', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            network graph</a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                            href="{{ url_for('visualisation.tags_cloud', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">View
                            tags cloud</a>
                    </li>
                    <li><a class="dropdown-item" href="#">View timeline</a></li>
                    <li><a class="dropdown-item" href="#">View geographic map</a></li>
                </ul>
            </li>
        </ul>
        {% endif %}
    </div>
</div>
<!-- Topic -->
<div class="row mt-4">
    <div class="col-md-8">
        <!-- Topic title -->
        <h1>{% if topic.instance_of == 'tag' %}{{ topic.identifier }} <small class="text-muted"
                style="font-size: 60%;"><i style="color: gray" class="bi bi-house-fill"></i></small>
            {% else %}
            {{ topic.first_base_name.name }} {% if topic.identifier == 'home' %}<small><i style="color: gray"
                    class="bi bi-house-fill"></i></small>{% endif %}
            {% endif %}
        </h1>
        <p><em>{{ creation_date }}</em></p>
        <!-- Topic text -->
        <hr />
        {% if occurrences['text'] %}
        {{ occurrences['text']|safe }}
        <p><small><a href="#page-top">Back to top</a></small></p>
        {% else %}
        {% if is_map_owner %}
        <p class="alert alert-info" role="alert">
            This topic has no text. Click on the "Edit topic" button below to add text to this topic.
        </p>
        <a class="btn btn-primary"
            href="{{ url_for('topic.edit', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Edit
            topic</a>
        <br />
        <br />
        {% else %}
        <p class="alert alert-info" role="alert">
            This topic has no text.
        </p>
        {% endif %}
        {% endif %}
        <!-- Topic notes -->
        {% if occurrences['notes'] %}
        <hr />
        <h5>Notes</h5>
        {% for note in occurrences['notes'] %}
        <a name="note-{{ note.identifier }}"></a>
        <div class="card border-warning">
            <div class="card-header">
                <small class="text-muted">{{ note.timestamp }}</small>
            </div>
            <div class="card-body text-secondary">
                <h5 class="card-title">{{ note.title }}</h5>
                <p class="card-text">{{ note.text|safe }}</p>
            </div>
            {% if current_user.is_authenticated and (collaboration_mode.name == "EDIT" or
            collaboration_mode.name ==
            "COMMENT") %}
            <div class="card-footer">
                <div class="btn-group my-1">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Options
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item"
                                    href="{{ url_for('topic.edit_note', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, note_identifier=note.identifier) }}">Edit</a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                    href="{{ url_for('topic.delete_note', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, note_identifier=note.identifier) }}">Delete</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <br />
        {% endfor %}
        <p><small><a href="#page-top">Back to top</a></small></p>
        {% endif %}
    </div>
    <div class="col-md-4">
        <!-- Current context -->
        <div class="card contextualise-card">
            <div class="card-header">
                <strong>Current context</strong>
            </div>
            <div class="card-body">
                <ul>
                    <li>Map: <a href="{{ url_for('map.view', map_identifier=topic_map.identifier) }}">{{
                            topic_map.name }}</a>
                        {% if current_user.is_authenticated %}
                        {% if topic_map.published %}
                        <span class="badge text-bg-success">Published</span>
                        {% else %}
                        <span class="badge text-bg-warning">Private</span>
                        {% endif %}
                        {% endif %}
                    </li>
                    <li>Topic: {{ topic.first_base_name.name }}</li>
                    {% if session['current_scope'] == '*' %}
                    <li>Scope: <a
                            href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier=session['current_scope']) }}">{{
                            session['current_scope']|topic_name(topic_map.identifier) }}</a>
                    </li>
                    {% else %}
                    <li>Scope: <a
                            href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier=session['current_scope'], scope=session['current_scope']) }}">{{
                            session['current_scope']|topic_name(topic_map.identifier) }}</a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and not is_map_owner %}
                    <li>
                        Collaboration mode: {% if collaboration_mode.name == "VIEW" %}
                        <span class="text-info"><strong>Can view</strong></span>
                        {% elif collaboration_mode.name == "COMMENT" %}
                        <span class="text-secondary"><strong>Can comment</strong></span>
                        {% elif collaboration_mode.name == "EDIT" %}
                        <span class="text-warning"><strong>Can edit</strong></span>
                        {% else %}
                        <span class="text-secondary"><strong>None</strong></span>
                        {% endif %}
                    </li>
                    {% endif %}
                </ul>
            </div>
            {% if is_map_owner %}
            <div class="card-footer">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        Options
                    </button>

                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item"
                                href="{{ url_for('topic.change_scope', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, scope_identifier=session['current_scope']) }}">Change
                                scope</a>
                        </li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        {% if session['scope_filter'] == 1 %}
                        <li>
                            <a class="dropdown-item"
                                href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, filter=0) }}">Disable
                                scope filtering</a>
                        </li>
                        <li><a class="dropdown-item disabled">Enable scope filtering</a></li>
                        {% else %}
                        <li><a class="dropdown-item disabled">Disable scope filtering</a></li>
                        <a class="dropdown-item"
                            href="{{ url_for('topic.view', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, filter=1) }}">Enable
                            scope filtering</a>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
        <br />
        <!-- Topic resources -->
        {% if occurrences['images'] or occurrences['3d-scenes'] or occurrences['files'] or
        occurrences['links'] or occurrences['videos'] %}
        <div class="card contextualise-card">
            <div class="card-header">
                <strong>Topic resources</strong>
            </div>
            <div class="card-body">
                <ul>
                    {% if occurrences['images'] %}
                    <li>{% if is_map_owner %}
                        <a
                            href="{{ url_for('image.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Images</a>
                        {% else %}
                        Images
                        {% endif %}
                        <ul>
                            {% for image in occurrences['images'] %}
                            <li>
                                <a data-caption="{{ image.title }}" data-fancybox="images"
                                    href="/static/resources/{{ topic_map.identifier }}/{{ image.url }}">{{
                                    image.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                    {% if occurrences['files'] %}
                    <li>{% if is_map_owner %}
                        <a
                            href="{{ url_for('file.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Files</a>
                        {% else %}
                        Files
                        {% endif %}
                        <ul>
                            {% for file in occurrences['files'] %}
                            <li>
                                <a href="/static/resources/{{ topic_map.identifier }}/{{ file.url }}">{{
                                    file.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                    {% if occurrences['videos'] %}
                    <li>{% if is_map_owner %}
                        <a
                            href="{{ url_for('video.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Videos</a>
                        {% else %}
                        Videos
                        {% endif %}
                        <ul>
                            {% for video in occurrences['videos'] %}
                            <li>
                                <a data-caption="{{ video.title }}" data-fancybox="gallery" href="{{ video.url }}">{{
                                    video.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                    {% if occurrences['links'] %}
                    <li>{% if is_map_owner %}
                        <a
                            href="{{ url_for('link.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">Links</a>
                        {% else %}
                        Links
                        {% endif %}
                        <ul>
                            {% for link in occurrences['links'] %}
                            <li>
                                <a href="{{ link.url }}" target="_blank">{{ link.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                    {% if occurrences['3d-scenes'] %}
                    <li>{% if is_map_owner %}
                        <a
                            href="{{ url_for('three_d.index', map_identifier=topic_map.identifier, topic_identifier=topic.identifier) }}">3D</a>
                        {% else %}
                        3D
                        {% endif %}
                        <ul>
                            {% for scene in occurrences['3d-scenes'] %}
                            <li><a data-fancybox
                                    data-src="{{ url_for('three_d.view', map_identifier=topic_map.identifier, topic_identifier=topic.identifier, file_url=scene.url) }}"
                                    data-type="iframe" href="javascript:">{{ scene.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        <br />
        {% endif %}
        <!-- Topic associations -->
        <div id="associations-component">
            <template v-if="visibleAssociations.length > 0">
                <div class="card bg-light">
                    <div class="card-header">
                        <strong>Related topics</strong>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li v-for="association in visibleAssociations" :key="association.identifier">${
                                association.name }
                                <ul>
                                    <li v-for="role in association.roles" :key="role.identifier">
                                        ${ role.name }
                                        <ul>
                                            <li v-for="topicRef in role.topicRefs" :key="topicRef.identifier">
                                                <a v-if="currentScope === '*'" :href="topicRef.identifier">${
                                                    topicRef.name }</a>
                                                <a v-else :href="topicRef.identifier + '?scope=' + currentScope">${
                                                    topicRef.name }</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Options
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item"
                                        :href="'/visualisations/network/' + mapIdentifier + '/' + topicIdentifier">View
                                        network graph</a>
                                </li>
                                <li>
                                    <div v-if="isAuthenticated && hasWriteAccess" class="dropdown-divider"></div>
                                </li>
                                <li>
                                    <a v-if="isAuthenticated && hasWriteAccess" href="#"
                                        class="dropdown-item create-association-link">Create generic
                                        association</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}